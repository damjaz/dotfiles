#!/bin/bash

# load terminal colorscheme variables COL0 - COL15
. colors-def

panel_cmd="bar -g x20 -B#$COL0 -F#$COL15 -f terminus-12"

date_widget() {
  local date=$(date '+%A %d %B')
  echo "date:%{F#ff$COL3}${date,,}%{F-}"
}

time_widget() {
  local time=$(date '+%H:%M')
  echo "time:%{F#ff$COL3}$time%{F-}"
}

battery_widget() {
  local battery_dir='/sys/class/power_supply/BAT0'
  local battery_status=$(< "$battery_dir/status")
  
  case $battery_status in
    Full|Charging)
      battery_status="%{F#ff$COL3}${battery_status,,}%{F-}"
    ;;
    *)
      local charge_now=$(< "$battery_dir/charge_now")
      local charge_full=$(< "$battery_dir/charge_full")
      local percents=$(( charge_now * 100 / charge_full ))
      battery_status="%{F#ff$COL1}${battery_status,,} $percents%%%{F-}"
    ;;
  esac
  echo "battery:$battery_status"
}

title_widget() {
    local id="$(bspc query -W -w focused)"
    local title=''
    local delim='"'

    if [[ "$id" ]]; then
      title="$(xprop WM_NAME -id $id | cut -d $delim -f 2)"
    fi
    echo "title:%{F#ff$COL3}$title%{F-}"
}

wifi_widget() {
    local ssid="$(iwgetid -r)"

    if [[ "$ssid" ]]; then
      ssid="%{F#ff$COL3}$ssid%{F-}"
    else
      ssid="%{F#ff$COL1}wifi off%{F-}"
    fi
    echo "wifi:$ssid"
}

desktops_widget() {
  bspc control --subscribe | while read -r line; do
    bspwm_status=(${line//:/ })
    desktops=''
    for field in "${bspwm_status[@]}"; do
      case $field in
        O*|U*|F*)
          desktops+="%{B#ff$COL2} ${field#?} %{B-}"
        ;;
        o*|u*)
          desktops+=" ${field#?} "
        ;;
        f*)
          desktops+="%{F#ff$COL6} ${field#?} %{F-}"
        ;;
        *) ;;
      esac
    done
    echo "desktops:$desktops"
  done
}

widgets_format() {
  while read -r line; do
    case $line in
      date*)
        date="${line#*:}"
      ;;
      time*)
        time="${line#*:}"
      ;;
      battery*)
        battery="${line#*:}"
      ;;
      title*)
        title="${line#*:}"
      ;;
      wifi*)
        wifi="${line#*:}"
      ;;
      desktops*)
        desktops="${line#*:}"
      ;;
      *) ;;
    esac
  
    fmt="%{l}$desktops > $title"
    fmt+="%{r}$wifi < $battery < $date < $time "
    echo "$fmt"
  done
}

# main
{
  desktops_widget &
  while true; do
    title_widget
    wifi_widget
    battery_widget
    date_widget
    time_widget
    sleep 1
  done &
} | widgets_format | $panel_cmd &

